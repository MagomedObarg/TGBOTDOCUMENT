# 🏗️ Архитектура проекта

Документ описывает архитектуру Telegram-бота для генерации документов.

## 📐 Общая архитектура

```
┌─────────────────┐
│   Пользователь  │
└────────┬────────┘
         │ Telegram API
         ↓
┌─────────────────┐
│   Telegram Bot  │ ← aiogram 3.x
│   (bot.py)      │
└────────┬────────┘
         │
         ├─→ Handlers (обработчики команд)
         │   ├─ basic_handlers.py (/start, /help)
         │   └─ document_handlers.py (FSM, генерация)
         │
         ├─→ Services (бизнес-логика)
         │   ├─ gemini_service.py ← Google Gemini API
         │   └─ document_service.py ← python-docx, reportlab
         │
         └─→ Utils (вспомогательные функции)
             └─ keyboards.py (клавиатуры)
```

## 📦 Структура модулей

### 1. Bot (bot.py)

**Ответственность:**
- Инициализация бота и диспетчера
- Регистрация обработчиков
- Управление жизненным циклом приложения
- Логирование

**Зависимости:**
- aiogram (Bot, Dispatcher)
- handlers (basic_handlers, document_handlers)
- services (GeminiService, DocumentService)
- config (Config)

### 2. Config (config.py)

**Ответственность:**
- Загрузка переменных окружения
- Конфигурация приложения
- Валидация настроек
- Определение констант

**Настройки:**
- API ключи (Telegram, Gemini)
- Лимиты (длина запроса, размеры файлов)
- Шаблоны документов
- Пути к директориям

### 3. Handlers (обработчики)

#### basic_handlers.py

**Ответственность:**
- Обработка базовых команд
- Приветствие и помощь
- Информация о боте

**Команды:**
- `/start` - приветствие
- `/help` - справка
- Кнопки меню

#### document_handlers.py

**Ответственность:**
- Управление процессом создания документа
- FSM (состояния диалога)
- Обработка callback-запросов
- Отправка документов пользователю

**FSM состояния:**
1. `choosing_template` - выбор шаблона
2. `entering_request` - ввод описания
3. `choosing_doc_type` - выбор формата

**Процесс:**
```
/generate
    ↓
Выбор шаблона (inline keyboard)
    ↓
Ввод описания (text input)
    ↓
Валидация длины
    ↓
Выбор формата (Word/PDF)
    ↓
Генерация контента (Gemini API)
    ↓
Создание документа (docx/pdf)
    ↓
Отправка пользователю
    ↓
Очистка временных файлов
```

### 4. Services (сервисы)

#### gemini_service.py

**Ответственность:**
- Взаимодействие с Google Gemini API
- Формирование промптов
- Генерация текстового контента
- Обработка ошибок API

**Методы:**
- `generate_document_content()` - генерация контента
- `_create_prompt()` - создание промпта по шаблону
- `_generate_async()` - асинхронный вызов API

**Шаблоны промптов:**
- Договор (юридический стиль)
- Заявление (официальный стиль)
- Резюме (структурированное)
- Письмо (деловой стиль)
- Отчёт (аналитический стиль)
- Произвольный (универсальный)

#### document_service.py

**Ответственность:**
- Создание документов Word
- Создание документов PDF
- Форматирование текста
- Управление файлами

**Методы:**
- `create_word_document()` - создание .docx
- `create_pdf_document()` - создание .pdf
- `cleanup_file()` - удаление временных файлов

**Форматирование:**
- Word: Times New Roman, 12pt, выравнивание
- PDF: встроенные шрифты, параграфы, отступы

### 5. Utils (утилиты)

#### keyboards.py

**Ответственность:**
- Создание клавиатур Telegram
- Reply keyboards (постоянные кнопки)
- Inline keyboards (кнопки под сообщениями)

**Клавиатуры:**
- `get_main_keyboard()` - главное меню
- `get_template_keyboard()` - выбор шаблона
- `get_document_type_keyboard()` - выбор формата
- `get_cancel_keyboard()` - отмена действия

## 🔄 Потоки данных

### Поток генерации документа

```
1. Пользователь → Команда /generate
   ↓
2. Handler → FSM State (choosing_template)
   ↓
3. User → Выбор шаблона (callback)
   ↓
4. Handler → Сохранение в state.data
   ↓
5. Handler → FSM State (entering_request)
   ↓
6. User → Текстовое описание
   ↓
7. Handler → Валидация текста
   ↓
8. Handler → FSM State (choosing_doc_type)
   ↓
9. User → Выбор формата (callback)
   ↓
10. Handler → gemini_service.generate_content()
    ↓
11. Gemini API → Сгенерированный текст
    ↓
12. Handler → document_service.create_document()
    ↓
13. Document Service → Файл документа
    ↓
14. Handler → Отправка файла в Telegram
    ↓
15. Handler → Cleanup временных файлов
    ↓
16. Handler → FSM clear state
```

## 🔐 Безопасность

### Защита API ключей
- Хранение в `.env` (не в репозитории)
- Валидация при старте
- Логирование без ключей

### Валидация входных данных
- Ограничение длины запроса
- Проверка типов данных
- Санитизация текста для PDF

### Управление файлами
- Уникальные имена (timestamp + user_id)
- Автоматическое удаление после отправки
- Ограничение на размер директории

## ⚡ Производительность

### Асинхронность
- Все I/O операции асинхронные
- Использование async/await
- Неблокирующие вызовы API

### Оптимизации
- Ленивая инициализация сервисов
- Переиспользование соединений
- Минимальное логирование в production

### Масштабирование
- Stateless архитектура
- Возможность запуска нескольких инстансов
- Горизонтальное масштабирование с load balancer

## 🗄️ Хранение данных

### Текущее состояние
- FSM хранит состояние в памяти (aiogram)
- Временные файлы в `generated_docs/`
- Логи в `bot.log`

### Возможные улучшения
```python
# Добавление БД для истории
┌─────────────┐
│  PostgreSQL │
│  или Redis  │
└──────┬──────┘
       │
       ├─ users (id, username, created_at)
       ├─ documents (id, user_id, type, created_at)
       └─ requests (id, user_id, content, response)
```

## 🧪 Тестирование

### Слои тестирования

```
┌─────────────────────┐
│  Integration Tests  │ ← Полный цикл генерации
├─────────────────────┤
│   Service Tests     │ ← Gemini, Document services
├─────────────────────┤
│   Handler Tests     │ ← Обработчики команд
├─────────────────────┤
│    Unit Tests       │ ← Отдельные функции
└─────────────────────┘
```

### Моки и фикстуры
- Mock Gemini API для тестов
- Фикстуры для FSM состояний
- Временные файлы для тестов

## 📊 Логирование

### Уровни логирования

```python
logger.info()   # Информация о ходе выполнения
logger.warning() # Предупреждения (не критично)
logger.error()   # Ошибки (требуют внимания)
```

### Что логируется
- Запуск/остановка бота
- Действия пользователей
- Запросы к API
- Ошибки и исключения
- Создание/удаление файлов

## 🚀 Развёртывание

### Варианты развёртывания

#### 1. VPS + Systemd
```
User → Telegram API → VPS Server
                       ├─ Python Bot
                       ├─ Systemd (автозапуск)
                       └─ Logs
```

#### 2. Docker
```
User → Telegram API → Docker Container
                       ├─ Python Bot
                       ├─ Volume (документы)
                       └─ Volume (логи)
```

#### 3. Kubernetes (для масштабирования)
```
User → Telegram API → Load Balancer
                       ├─ Bot Pod 1
                       ├─ Bot Pod 2
                       └─ Bot Pod N
                       └─ Shared Storage
```

## 🔮 Будущие улучшения

### Краткосрочные
- [ ] Добавление базы данных
- [ ] Кеширование частых запросов
- [ ] Rate limiting на пользователя
- [ ] Метрики и мониторинг

### Среднесрочные
- [ ] Поддержка нескольких языков (i18n)
- [ ] Пользовательские шаблоны
- [ ] Редактирование документов
- [ ] Webhook режим (вместо polling)

### Долгосрочные
- [ ] Веб-интерфейс для настройки
- [ ] Интеграция с Google Drive
- [ ] Командная работа над документами
- [ ] AI ассистент для улучшения текстов

## 📚 Паттерны проектирования

### Используемые паттерны

1. **Dependency Injection**
   - Сервисы передаются в обработчики

2. **Service Layer**
   - Отделение бизнес-логики от обработчиков

3. **State Machine (FSM)**
   - Управление диалогом с пользователем

4. **Strategy**
   - Разные шаблоны документов

5. **Factory**
   - Создание разных типов документов

## 🔗 Внешние зависимости

### API
- **Telegram Bot API** - взаимодействие с пользователями
- **Google Gemini API** - генерация контента

### Библиотеки
- **aiogram** - Telegram Bot Framework
- **google-generativeai** - Gemini API клиент
- **python-docx** - создание Word документов
- **reportlab** - создание PDF документов
- **python-dotenv** - переменные окружения

### Инфраструктура
- Python 3.8+
- Сервер с доступом в интернет
- Файловая система для временных файлов

---

**Версия:** 1.0.0
**Дата:** 2024
**Статус:** Production Ready
