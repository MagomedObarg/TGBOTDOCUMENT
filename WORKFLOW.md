# 🔄 Workflow и сценарии использования

Визуальное описание работы бота и различных сценариев использования.

## 📱 Основной workflow

```
┌─────────────────────────────────────────────────────────────┐
│                    Пользователь открывает бота               │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ↓
                    📲 /start
                          │
                          ↓
          ┌───────────────────────────────┐
          │   Приветственное сообщение    │
          │   + Главное меню              │
          │   [📝 Создать документ]       │
          │   [❓ Помощь] [ℹ️ О боте]    │
          └───────────────┬───────────────┘
                          │
          ┌───────────────┴───────────────┐
          │                               │
    📝 Создать                      ❓ Помощь
          │                               │
          ↓                               ↓
   [Генерация документа]         [Справочная информация]
```

## 📝 Процесс создания документа

```
START: Нажата кнопка "📝 Создать документ" или /generate
   │
   ↓
┌─────────────────────────────────────────────────────┐
│  ШАГ 1: ВЫБОР ШАБЛОНА                               │
│  ━━━━━━━━━━━━━━━━━━━━                              │
│  Бот показывает inline-клавиатуру:                  │
│  [📄 Договор]                                       │
│  [📋 Заявление]                                     │
│  [👔 Резюме]                                        │
│  [✉️ Деловое письмо]                               │
│  [📊 Отчёт]                                         │
│  [📝 Произвольный документ]                         │
│                                                     │
│  State: choosing_template                           │
└──────────────────────┬──────────────────────────────┘
                       │ Пользователь выбирает
                       ↓
┌─────────────────────────────────────────────────────┐
│  ШАГ 2: ВВОД ОПИСАНИЯ                               │
│  ━━━━━━━━━━━━━━━━━━                                │
│  Бот просит описать документ:                       │
│  "Опишите, какой документ вам нужен..."            │
│                                                     │
│  Валидация:                                         │
│  • Минимум 10 символов                             │
│  • Максимум 1000 символов                          │
│                                                     │
│  Кнопка: [❌ Отмена]                               │
│                                                     │
│  State: entering_request                            │
└──────────────────────┬──────────────────────────────┘
                       │ Пользователь вводит текст
                       ↓
              ✅ Валидация прошла?
                       │
         ┌─────────────┴─────────────┐
         NO                          YES
         │                            │
         ↓                            ↓
   ⚠️ Ошибка                 ШАГ 3: ВЫБОР ФОРМАТА
   "Слишком                          │
   короткое/длинное"                 ↓
         │                  ┌─────────────────────┐
         └──────────────────→│  Inline-клавиатура: │
                            │  [📄 Word .docx]    │
                            │  [📕 PDF]           │
                            │                     │
                            │  State:             │
                            │  choosing_doc_type  │
                            └──────────┬──────────┘
                                       │ Пользователь выбирает формат
                                       ↓
┌──────────────────────────────────────────────────────────────┐
│  ШАГ 4: ГЕНЕРАЦИЯ                                            │
│  ━━━━━━━━━━━━━━                                             │
│  ⏳ "Генерирую документ... Подождите 10-30 секунд"          │
│                                                              │
│  Процесс:                                                    │
│  1. 🧠 Вызов Gemini API                                      │
│     ├─ Формирование промпта по шаблону                       │
│     ├─ Отправка запроса к AI                                 │
│     └─ Получение сгенерированного текста                     │
│                                                              │
│  2. 📄 Создание документа                                    │
│     ├─ Форматирование текста                                 │
│     ├─ Применение стилей                                     │
│     └─ Сохранение в файл (.docx или .pdf)                    │
│                                                              │
│  3. 📤 Отправка файла                                        │
│     ├─ Upload файла в Telegram                               │
│     ├─ Добавление caption с информацией                      │
│     └─ Удаление временного файла                             │
└──────────────────────────────────────────────────────────────┘
                                       │
                                       ↓
                              ✅ ДОКУМЕНТ ГОТОВ!
                                       │
                                       ↓
┌──────────────────────────────────────────────────────────────┐
│  Пользователь получает:                                      │
│  📎 Файл документа (document.docx или document.pdf)          │
│  ✅ Документ готов!                                          │
│  📋 Тип: [Выбранный шаблон]                                  │
│  📄 Формат: [Word/PDF]                                       │
│  📊 Размер контента: [N] символов                            │
└──────────────────────────────────────────────────────────────┘
                                       │
                                       ↓
                              FSM State: cleared
                              Готов к новому запросу
END
```

## 🔀 Альтернативные сценарии

### Сценарий 1: Отмена операции

```
Пользователь в процессе создания документа
              │
              ↓
        [❌ Отмена]
         или /cancel
              │
              ↓
      FSM State cleared
              │
              ↓
    "❌ Создание документа отменено"
              │
              ↓
      Возврат в главное меню
```

### Сценарий 2: Ошибка API

```
Генерация документа
        │
        ↓
    API запрос
        │
        ├─ Timeout ───────────┐
        ├─ Rate limit ────────┤
        ├─ Invalid API key ───┤
        └─ Network error ─────┤
                              ↓
                    ❌ Обработка ошибки
                              │
                              ↓
            "❌ Ошибка при генерации документа.
             Пожалуйста, попробуйте ещё раз."
                              │
                              ↓
                    FSM State cleared
                              │
                              ↓
                    Возврат в главное меню
```

### Сценарий 3: Слишком длинный запрос

```
Пользователь вводит описание
              │
              ↓
    Проверка длины текста
              │
        len > 1000?
              │
             YES
              ↓
    "⚠️ Ваш запрос слишком длинный
     (N символов). Максимум: 1000."
              │
              ↓
    Ожидание нового ввода
    (State не меняется)
```

## 📊 Диаграмма состояний FSM

```
                    ┌─────────┐
                    │   IDLE  │ (начальное состояние)
                    └────┬────┘
                         │
                    /generate или
                    "📝 Создать документ"
                         │
                         ↓
        ┌────────────────────────────────┐
        │   choosing_template            │
        │   ━━━━━━━━━━━━━━━━━━          │
        │   • Показ шаблонов             │
        │   • Ожидание callback          │
        └────────────┬───────────────────┘
                     │
              callback: template_*
                     │
                     ↓
        ┌────────────────────────────────┐
        │   entering_request             │
        │   ━━━━━━━━━━━━━━━━            │
        │   • Запрос описания            │
        │   • Валидация длины            │
        │   • Кнопка "Отмена"            │
        └────────────┬───────────────────┘
                     │
              text input (validated)
                     │
                     ↓
        ┌────────────────────────────────┐
        │   choosing_doc_type            │
        │   ━━━━━━━━━━━━━━━━            │
        │   • Выбор формата              │
        │   • Ожидание callback          │
        └────────────┬───────────────────┘
                     │
              callback: doctype_*
                     │
                     ↓
        ┌────────────────────────────────┐
        │   PROCESSING                   │
        │   ━━━━━━━━━━                   │
        │   • Генерация (Gemini API)     │
        │   • Создание документа         │
        │   • Отправка файла             │
        └────────────┬───────────────────┘
                     │
                 Завершено
                     │
                     ↓
                ┌─────────┐
                │   IDLE  │ (state.clear())
                └─────────┘
```

## 🎯 Примеры реальных диалогов

### Пример 1: Создание резюме

```
👤 Пользователь: /start

🤖 Бот: 👋 Привет! Я бот для генерации документов...
        [📝 Создать документ] [❓ Помощь] [ℹ️ О боте]

👤 Пользователь: [нажимает "📝 Создать документ"]

🤖 Бот: Выберите тип шаблона документа:
        [📄 Договор] [📋 Заявление] [👔 Резюме] ...

👤 Пользователь: [нажимает "👔 Резюме"]

🤖 Бот: ✅ Выбран шаблон: Резюме
        
        📝 Теперь опишите, какой документ вам нужен...

👤 Пользователь: Составь резюме на позицию Python разработчика.
                 ФИО: Иванов Иван, 28 лет
                 Опыт: 5 лет Python, Django, PostgreSQL
                 Образование: МГУ, ВМК

🤖 Бот: ✅ Описание принято!
        
        Выберите формат документа:
        [📄 Word документ] [📕 PDF документ]

👤 Пользователь: [нажимает "📄 Word документ"]

🤖 Бот: ⏳ Генерирую документ...
        Это может занять 10-30 секунд...

🤖 Бот: 📎 [отправляет файл resume_123456_20240101.docx]
        ✅ Документ готов!
        📋 Тип: Резюме
        📄 Формат: Word документ (.docx)
        📊 Размер контента: 1523 символов
```

### Пример 2: Отмена операции

```
👤 Пользователь: /generate

🤖 Бот: Выберите тип шаблона...

👤 Пользователь: [выбирает "📄 Договор"]

🤖 Бот: Опишите договор...
        [❌ Отмена]

👤 Пользователь: [нажимает "❌ Отмена"]

🤖 Бот: ❌ Создание документа отменено.
        [📝 Создать документ] [❓ Помощь] [ℹ️ О боте]
```

## 🔧 Технический workflow

### Обработка команды /start

```python
User sends: /start
    ↓
basic_handlers.cmd_start()
    ↓
state.clear()  # Очистка любого предыдущего состояния
    ↓
Send welcome message
    ↓
Attach main keyboard
    ↓
Log action
```

### Генерация документа (полный цикл)

```python
User clicks: "📝 Создать документ"
    ↓
document_handlers.start_document_generation()
    ↓
state.set_state(DocumentGeneration.choosing_template)
    ↓
Send template keyboard
    ↓
User clicks: template callback
    ↓
document_handlers.template_chosen()
    ↓
state.update_data(template_type=..., template_name=...)
    ↓
state.set_state(DocumentGeneration.entering_request)
    ↓
User sends: text description
    ↓
document_handlers.request_entered()
    ↓
Validate text length
    ↓
state.update_data(user_request=...)
    ↓
state.set_state(DocumentGeneration.choosing_doc_type)
    ↓
User clicks: doctype callback
    ↓
document_handlers.document_type_chosen()
    ↓
data = await state.get_data()
    ↓
gemini_service.generate_document_content(
    user_request=data['user_request'],
    template_type=data['template_type']
)
    ↓
Gemini API returns content
    ↓
document_service.create_[word|pdf]_document(
    content=content,
    title=data['template_name'],
    user_id=user.id
)
    ↓
Send document to user
    ↓
document_service.cleanup_file(filepath)
    ↓
state.clear()
    ↓
Log success
```

## 📈 Метрики и мониторинг

### Ключевые метрики для отслеживания

```
┌─────────────────────────────────────────┐
│  Метрики использования                  │
├─────────────────────────────────────────┤
│  • Количество запусков бота (/start)    │
│  • Количество созданных документов      │
│  • Популярные типы шаблонов             │
│  • Соотношение Word vs PDF              │
│  • Средняя длина запросов               │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  Метрики производительности             │
├─────────────────────────────────────────┤
│  • Время генерации контента (Gemini)    │
│  • Время создания документа             │
│  • Общее время обработки запроса        │
│  • Размер генерируемых файлов           │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  Метрики ошибок                         │
├─────────────────────────────────────────┤
│  • Количество ошибок API                │
│  • Количество отмен операций            │
│  • Неуспешные генерации                 │
│  • Ошибки валидации                     │
└─────────────────────────────────────────┘
```

---

**Этот документ описывает все основные сценарии использования бота**
