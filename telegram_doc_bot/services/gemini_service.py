"""
Сервис для работы с Google Gemini API.
Генерирует текстовый контент на основе запросов пользователя.
"""

import logging
import google.generativeai as genai
from typing import Optional

logger = logging.getLogger(__name__)


class GeminiService:
    """Класс для взаимодействия с Google Gemini API"""
    
    def __init__(self, api_key: str):
        """
        Инициализация сервиса Gemini
        
        Args:
            api_key: API ключ Google Gemini
        """
        self.api_key = api_key
        genai.configure(api_key=api_key)
        self.model = genai.GenerativeModel('gemini-pro')
        logger.info("Gemini сервис инициализирован")
    
    async def generate_document_content(
        self,
        user_request: str,
        template_type: str = 'custom'
    ) -> Optional[str]:
        """
        Генерация содержимого документа на основе запроса пользователя
        
        Args:
            user_request: Запрос пользователя с описанием документа
            template_type: Тип шаблона документа
        
        Returns:
            Сгенерированный текст документа или None в случае ошибки
        """
        try:
            # Формирование промпта в зависимости от типа шаблона
            prompt = self._create_prompt(user_request, template_type)
            
            logger.info(f"Генерация документа типа '{template_type}' для запроса: {user_request[:50]}...")
            
            # Генерация контента
            response = await self._generate_async(prompt)
            
            if response:
                logger.info(f"Документ успешно сгенерирован, длина: {len(response)} символов")
                return response
            else:
                logger.error("Не удалось получить ответ от Gemini API")
                return None
                
        except Exception as e:
            logger.error(f"Ошибка при генерации контента: {e}")
            return None
    
    async def _generate_async(self, prompt: str) -> Optional[str]:
        """
        Асинхронная генерация текста через Gemini API
        
        Args:
            prompt: Промпт для генерации
        
        Returns:
            Сгенерированный текст или None
        """
        try:
            # Используем синхронный метод в асинхронной обёртке
            # так как библиотека google-generativeai не поддерживает async/await
            response = self.model.generate_content(prompt)
            
            if response and response.text:
                return response.text
            return None
            
        except Exception as e:
            logger.error(f"Ошибка API Gemini: {e}")
            return None
    
    async def edit_document_content(
        self,
        original_content: str,
        edit_instructions: str,
        template_type: str = 'custom'
    ) -> Optional[str]:
        """
        Редактирование содержимого документа на основе инструкций
        
        Args:
            original_content: Исходное содержимое документа
            edit_instructions: Инструкции по редактированию
            template_type: Тип шаблона документа
        
        Returns:
            Обновлённый текст документа или None в случае ошибки
        """
        try:
            prompt = self._create_edit_prompt(original_content, edit_instructions, template_type)
            
            logger.info(f"Редактирование документа с инструкциями: {edit_instructions[:50]}...")
            
            response = await self._generate_async(prompt)
            
            if response:
                logger.info(f"Документ успешно отредактирован, длина: {len(response)} символов")
                return response
            else:
                logger.error("Не удалось получить ответ от Gemini API при редактировании")
                return None
                
        except Exception as e:
            logger.error(f"Ошибка при редактировании контента: {e}")
            return None
    
    def _create_edit_prompt(
        self,
        original_content: str,
        edit_instructions: str,
        template_type: str
    ) -> str:
        """
        Создание промпта для редактирования документа
        
        Args:
            original_content: Исходное содержимое
            edit_instructions: Инструкции по редактированию
            template_type: Тип шаблона документа
        
        Returns:
            Сформированный промпт для редактирования
        """
        prompt = f"""
Ты - профессиональный редактор документов. Текущий тип документа: {template_type}.
У тебя есть существующий документ и инструкции по его изменению.

ИСХОДНЫЙ ДОКУМЕНТ:
```
{original_content}
```

ИНСТРУКЦИИ ПО РЕДАКТИРОВАНИЮ:
{edit_instructions}

ЗАДАЧА:
Отредактируй документ согласно инструкциям. Сохрани общую структуру и стиль документа, внеся только необходимые изменения.

ВАЖНО:
- Сохрани форматирование Markdown (##, ###, **, *, списки)
- Не удаляй важные разделы, если это не указано в инструкциях
- Сохрани профессиональный стиль и тон документа
- Если инструкция требует добавить информацию - добавь её логично в структуру
- Если инструкция требует удалить что-то - аккуратно удали, сохранив целостность документа
- Если инструкция требует изменить стиль - примени изменения ко всему документу

Верни полный отредактированный документ с применёнными изменениями.
"""
        return prompt
    
    def _create_prompt(self, user_request: str, template_type: str) -> str:
        """
        Создание промпта для Gemini на основе типа документа
        
        Args:
            user_request: Запрос пользователя
            template_type: Тип шаблона документа
        
        Returns:
            Сформированный промпт
        """
        base_prompts = {
            'contract': """
Ты - профессиональный юрист. Создай юридически грамотный договор на основе следующего запроса:

{request}

Документ должен содержать:
- Заголовок
- Преамбулу с указанием сторон
- Предмет договора
- Права и обязанности сторон
- Срок действия договора
- Порядок разрешения споров
- Заключительные положения
- Подписи сторон

Используй формальный юридический язык. Текст должен быть структурированным и профессиональным.

ВАЖНО: Форматируй текст с использованием Markdown:
- Используй ## для основных разделов (например: ## Предмет договора)
- Используй **жирный текст** для важных терминов
- Используй нумерованные списки (1., 2., 3.) для пунктов
- Используй маркированные списки (* или -) для перечислений
""",
            'statement': """
Создай официальное заявление на основе следующего запроса:

{request}

Документ должен содержать:
- Кому адресовано (наименование организации, должность, ФИО руководителя)
- От кого (ФИО заявителя, адрес, контакты)
- Заголовок "ЗАЯВЛЕНИЕ"
- Основной текст с изложением просьбы/требования
- Дата и подпись

Используй официально-деловой стиль.

ВАЖНО: Форматируй текст с использованием Markdown:
- Используй ## для заголовков разделов
- Используй **жирный текст** для выделения ключевых моментов
- Структурируй текст с отступами и параграфами
""",
            'resume': """
Создай профессиональное резюме на основе следующих данных:

{request}

Документ должен содержать:
- ФИО и контактные данные
- Желаемая должность
- Краткое резюме (Summary)
- Опыт работы (в обратном хронологическом порядке)
- Образование
- Профессиональные навыки
- Дополнительная информация

Используй современный формат резюме. Текст должен быть лаконичным и информативным.

ВАЖНО: Форматируй текст с использованием Markdown:
- Используй ## для основных разделов (## Опыт работы, ## Образование)
- Используй ### для подразделов (названия компаний, должностей)
- Используй **жирный текст** для должностей и ключевых достижений
- Используй маркированные списки (*) для навыков и обязанностей
""",
            'letter': """
Создай деловое письмо на основе следующего запроса:

{request}

Документ должен содержать:
- Дату
- Адресата
- Приветствие
- Основной текст письма
- Заключительную формулу вежливости
- Подпись отправителя

Используй официально-деловой стиль, соблюдай этикет деловой переписки.

ВАЖНО: Форматируй текст с использованием Markdown:
- Используй **жирный текст** для важных моментов
- Структурируй текст с четкими параграфами
- Используй списки при необходимости перечисления
""",
            'report': """
Создай структурированный отчёт на основе следующего запроса:

{request}

Документ должен содержать:
- Заголовок отчёта
- Введение (цель и задачи)
- Основную часть с разделами
- Выводы и рекомендации
- Заключение

Используй деловой стиль. Структурируй информацию логично и последовательно.

ВАЖНО: Форматируй текст с использованием Markdown:
- Используй ## для основных разделов (## Введение, ## Основная часть)
- Используй ### для подразделов
- Используй **жирный текст** для ключевых выводов
- Используй нумерованные списки для последовательных шагов
- Используй маркированные списки для перечислений
""",
            'custom': """
Создай документ на основе следующего запроса:

{request}

Создай качественный, структурированный документ, соответствующий запросу.
Используй подходящий стиль и форматирование.
Добавь все необходимые разделы и элементы для полноценного документа.

ВАЖНО: Форматируй текст с использованием Markdown:
- Используй ## для основных разделов
- Используй ### для подразделов
- Используй **жирный текст** для важных терминов и ключевых моментов
- Используй *курсив* для пояснений и примечаний
- Используй списки (* или 1.) для структурирования информации
"""
        }
        
        prompt_template = base_prompts.get(template_type, base_prompts['custom'])
        return prompt_template.format(request=user_request)
